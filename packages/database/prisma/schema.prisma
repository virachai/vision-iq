// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  output = "../generated/client"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?

  @@map("vision_iq_users")
}

// Pexels Image Library
model PexelsImage {
  id              String   @id @default(cuid())
  pexelsId        String   @unique
  url             String
  photographer    String?
  width           Int?
  height          Int?
  avgColor        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  metadata        ImageMetadata?
  embedding       ImageEmbedding?
  analysisJob     ImageAnalysisJob?
  descriptions    PexelsImageDescription[] // Track which descriptions this image satisfies

  @@index([pexelsId])
  @@map("vision_iq_pexels_images")
}

// Vector embeddings for semantic search
model ImageEmbedding {
  id        String   @id @default(cuid())
  imageId   String   @unique
  image     PexelsImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  // 1536-dimensional embedding for semantic search
  embedding Unsupported("vector(1536)")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([imageId])
  // Note: HNSW index on embedding created in migration: CREATE INDEX ON "ImageEmbedding" USING hnsw ("embedding" vector_cosine_ops);
  @@map("vision_iq_image_embeddings")
}

// Image Analysis Metadata
model ImageMetadata {
  id                  String   @id @default(cuid())
  imageId             String   @unique
  image               PexelsImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  // Impact and visual properties
  impactScore         Float    @default(5.0) // 1.0 - 10.0: subject prominence and visual strength
  visualWeight        Float    @default(5.0) // contrast, saturation, focal clarity
  
  // Composition metadata
  composition         Json     // { "negative_space": "left" | "right" | "center", "shot_type": "CU" | "MS" | "WS", "angle": "low" | "eye" | "high" }
  
  // Mood/aesthetic metadata
  moodDna             Json     // { "temp": "warm" | "cold", "primary_color": "hex", "vibe": "minimalist" | "cinematic" | ... }
  
  // Metaphorical/semantic tags
  metaphoricalTags    String[] @default([]) // e.g., ["solitude", "breakthrough", "journey"]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([imageId])
  @@index([impactScore])
  @@map("vision_iq_image_metadata")
}

// Image Analysis Job Status
enum AnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model ImageAnalysisJob {
  id              String   @id @default(cuid())
  imageId         String   @unique
  image           PexelsImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  
  status          AnalysisStatus @default(PENDING)
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  
  errorMessage    String?
  result          Json?    // Stores analysis result from Gemini/DeepSeek
  rawResponse     String?  // Raw text response from AI for debugging
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([imageId])
  @@map("vision_iq_image_analysis_jobs")
}

// Scene Intent Request (stores raw Gemini narrative)
model VisualIntentRequest {
  id              String   @id @default(cuid())
  rawGeminiText   String   @db.Text
  
  // Relations
  scenes          SceneIntent[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("vision_iq_visual_intent_requests")
}

// Scene Intent from narrative parsing
model SceneIntent {
  id                  String   @id @default(cuid())
  requestId           String?  // Linked to the raw request
  request             VisualIntentRequest? @relation(fields: [requestId], references: [id], onDelete: SetNull)
  
  projectId           String   // FK to narrative/project
  sceneIndex          Int      // Order in narrative
  
  intent              String   // "show a lonely figure in vast landscape"
  requiredImpact      Float    // 1.0 - 10.0
  
  // Preferred composition constraints
  composition         Json     // { "negative_space": "left" | "right" | "center", "shot_type": "CU" | "MS" | "WS" }
  
  // Expanded detailed descriptions
  descriptions        VisualDescription[]
  
  // Visual anchor
  moodAnchor          Json?    // { "temp": "warm" | "cold", "primary_color": "hex" }
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([projectId])
  @@index([sceneIndex])
  @@index([requestId])
  @@map("vision_iq_scene_intents")
}

// Detailed visual descriptions expanded from a scene intent
model VisualDescription {
  id              String         @id @default(cuid())
  sceneIntentId   String
  sceneIntent     SceneIntent    @relation(fields: [sceneIntentId], references: [id], onDelete: Cascade)
  
  description     String         @db.Text
  analysis        Json?          // Captured DeepSeek analysis/summary metadata
  
  // Provenance tracking: images found for this specific description
  images          PexelsImageDescription[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([sceneIntentId])
  @@map("vision_iq_visual_descriptions")
}

// Join table for tracking image provenance (which description led to which image)
model PexelsImageDescription {
  id                  String            @id @default(cuid())
  descriptionId       String
  description         VisualDescription @relation(fields: [descriptionId], references: [id], onDelete: Cascade)
  
  pexelsImageId       String
  pexelsImage         PexelsImage       @relation(fields: [pexelsImageId], references: [id], onDelete: Cascade)
  
  matchScore          Float?            // Score at time of matching
  discoveryMethod     String            @default("SEARCH") // "SEARCH", "RECOMMENDED", "MANUAL"
  
  createdAt           DateTime          @default(now())

  @@unique([descriptionId, pexelsImageId])
  @@map("vision_iq_pexels_image_descriptions")
}

// Pexels Sync History
model PexelsSyncHistory {
  id              String   @id @default(cuid())
  searchQuery     String
  batchSize       Int
  status          String   // "pending", "completed", "failed"
  
  totalImages     Int      @default(0)
  totalBatches    Int      @default(0)
  
  error           String?
  jobIds          String[] @default([]) // List of analysis job IDs created
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("vision_iq_pexels_sync_history")
}
