generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String                @id @default(uuid())
  name          String?
  email         String?               @unique
  emailVerified DateTime?
  requests      VisualIntentRequest[]

  @@map("vision_iq_users")
}

model VisualIntentRequest {
  id            String         @id @default(uuid())
  userId        String?
  rawGeminiText String
  status        PipelineStatus @default(PENDING)
  retryCount    Int            @default(0)
  errorMessage  String?
  deletedAt     DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  scenes        SceneIntent[]
  user          User?          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("vision_iq_visual_intent_requests")
}

model SceneIntent {
  id                    String              @id @default(uuid())
  visualIntentRequestId String
  sceneIndex            Int
  intent                String
  requiredImpact        Float               @default(5.0)
  composition           Json
  status                PipelineStatus      @default(PENDING)
  retryCount            Int                 @default(0)
  errorMessage          String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  visualIntentRequest   VisualIntentRequest @relation(fields: [visualIntentRequestId], references: [id], onDelete: Cascade)
  descriptions          VisualDescription[]

  @@index([visualIntentRequestId])
  @@index([visualIntentRequestId, createdAt])
  @@map("vision_iq_scene_intents")
}

model VisualDescription {
  id            String                     @id @default(uuid())
  sceneIntentId String
  description   String
  status        PipelineStatus             @default(PENDING)
  retryCount    Int                        @default(0)
  errorMessage  String?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  tagMap        DescriptionTagMap[]
  keywords      VisualDescriptionKeyword[]
  sceneIntent   SceneIntent                @relation(fields: [sceneIntentId], references: [id], onDelete: Cascade)

  @@index([sceneIntentId])
  @@index([sceneIntentId, createdAt])
  @@map("vision_iq_visual_descriptions")
}

model VisualDescriptionKeyword {
  id                  String              @id @default(uuid())
  visualDescriptionId String
  keyword             String
  isUsed              Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  syncHistory         PexelsSyncHistory[]
  visualDescription   VisualDescription   @relation(fields: [visualDescriptionId], references: [id], onDelete: Cascade)

  @@index([visualDescriptionId])
  @@map("vision_iq_visual_description_keywords")
}

model PexelsSyncHistory {
  id           String                   @id @default(uuid())
  keywordId    String
  syncStatus   PipelineStatus           @default(PENDING)
  syncAttempt  Int                      @default(1)
  apiResponse  Json?
  errorMessage String?
  syncedAt     DateTime?                @default(now())
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  images       PexelsImage[]
  keyword      VisualDescriptionKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  @@index([keywordId])
  @@map("vision_iq_pexels_sync_history")
}

model PexelsImage {
  id                              String                           @id @default(uuid())
  syncHistoryId                   String
  pexelsImageId                   String                           @unique
  url                             String
  photographer                    String?
  width                           Int?
  height                          Int?
  avgColor                        String?
  alt                             String?
  createdAt                       DateTime                         @default(now())
  updatedAt                       DateTime                         @updatedAt
  analysisJobs                    ImageAnalysisJob?
  embedding                       ImageEmbedding?
  syncHistory                     PexelsSyncHistory                @relation(fields: [syncHistoryId], references: [id], onDelete: Cascade)
  visualIntentAnalysis            VisualIntentAnalysis?

  @@index([syncHistoryId])
  @@index([pexelsImageId])
  @@map("vision_iq_pexels_images")
}

model ImageAnalysisJob {
  id               String            @id @default(uuid())
  pexelsImageId    String            @unique
  jobStatus        PipelineStatus    @default(PENDING)
  provider         ApiProvider       @default(DEEPSEEK)
  payload          Json?
  rawApiResponse   Json?
  errorMessage     String?
  retryCount       Int               @default(0)
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  events           AnalysisEvent[]
  apiLogs          ApiLog[]
  deepseekAnalysis DeepSeekAnalysis?
  pexelsImage      PexelsImage       @relation(fields: [pexelsImageId], references: [id], onDelete: Cascade)

  @@index([pexelsImageId])
  @@index([jobStatus, provider])
  @@map("vision_iq_image_analysis_jobs")
}

model DeepSeekAnalysis {
  id              String           @id @default(uuid())
  analysisJobId   String           @unique
  modelVersion    String           @default("deepseek-v3")
  tokensUsed      Int              @default(0)
  analysisResult  Json
  confidenceScore Float            @default(1.0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  analysisJob     ImageAnalysisJob @relation(fields: [analysisJobId], references: [id], onDelete: Cascade)

  @@index([analysisJobId])
  @@map("vision_iq_deepseek_analysis")
}

model ApiLog {
  id              String            @id @default(uuid())
  jobId           String?
  provider        ApiProvider
  endpoint        String
  requestPayload  Json?
  responsePayload Json?
  statusCode      Int?
  durationMs      Int?
  createdAt       DateTime          @default(now())
  job             ImageAnalysisJob? @relation(fields: [jobId], references: [id])

  @@index([jobId])
  @@map("vision_iq_api_logs")
}

model AnalysisEvent {
  id        String           @id @default(uuid())
  jobId     String
  eventName String
  eventData Json?
  createdAt DateTime         @default(now())
  job       ImageAnalysisJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("vision_iq_analysis_events")
}

model Tag {
  id           String              @id @default(uuid())
  name         String              @unique
  descriptions DescriptionTagMap[]

  @@map("vision_iq_tags")
}

model DescriptionTagMap {
  descriptionId String
  tagId         String
  description   VisualDescription @relation(fields: [descriptionId], references: [id], onDelete: Cascade)
  tag           Tag               @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([descriptionId, tagId])
  @@map("vision_iq_description_tag_map")
}

model VisualIntentAnalysis {
  id                    String      @id @default(uuid())
  pexelsImageId         String      @unique
  coreIntent            Json?
  spatialStrategy       Json?
  subjectTreatment      Json?
  colorPsychology       Json?
  emotionalArchitecture Json?
  metaphoricalLayer     Json?
  cinematicLeverage     Json?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  pexelsImage           PexelsImage @relation(fields: [pexelsImageId], references: [id], onDelete: Cascade)

  @@index([pexelsImageId])
  @@map("vision_iq_visual_intent_analysis")
}

model ImageEmbedding {
  id        String      @id @default(uuid())
  imageId   String      @unique
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  image     PexelsImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  // embedding Unsupported("vector(768)")
  embedding Float[]

  @@index([imageId])
  @@map("vision_iq_image_embeddings")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ping {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

enum PipelineStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  STALLED
}

enum ApiProvider {
  PEXELS
  DEEPSEEK
  OPENAI
  GEMINI
}
