// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

// ðŸ”¹ Enums
enum PipelineStatus {
  PENDING     // Created but not yet in queue
  QUEUED      // Sent to BullMQ
  PROCESSING  // Currently being handled by a worker
  COMPLETED   // Success
  FAILED      // Terminal failure
  STALLED     // Timeout or heartbeat loss
}

enum ApiProvider {
  PEXELS
  DEEPSEEK
  OPENAI
  GEMINI
}

// ðŸ”¹ Core Tables
model User {
  id            String                @id @default(uuid())
  name          String?
  email         String?               @unique
  emailVerified DateTime?
  requests      VisualIntentRequest[]

  @@map("vision_iq_users")
}

model VisualIntentRequest {
  id            String              @id @default(uuid())
  userId        String?
  user          User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  rawGeminiText String              @db.Text
  status        PipelineStatus      @default(PENDING)
  retryCount    Int                 @default(0)
  errorMessage  String?             @db.Text
  deletedAt     DateTime? // Soft delete support

  scenes SceneIntent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("vision_iq_visual_intent_requests")
}

model SceneIntent {
  id                    String              @id @default(uuid())
  visualIntentRequestId String
  visualIntentRequest   VisualIntentRequest @relation(fields: [visualIntentRequestId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  sceneIndex     Int
  intent         String              @db.Text
  requiredImpact Float               @default(5.0)
  composition    Json // { "negative_space": "left" | "right" | "center", "shot_type": "CU" | "MS" | "WS" }
  status         PipelineStatus      @default(PENDING)
  retryCount     Int                 @default(0)
  errorMessage   String?             @db.Text

  descriptions VisualDescription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visualIntentRequestId])
  @@index([visualIntentRequestId, createdAt])
  @@map("vision_iq_scene_intents")
}

model VisualDescription {
  id            String      @id @default(uuid())
  sceneIntentId String
  sceneIntent   SceneIntent @relation(fields: [sceneIntentId], references: [id], onDelete: Cascade)

  description String              @db.Text
  status      PipelineStatus      @default(PENDING)
  retryCount  Int                 @default(0)
  errorMessage String?            @db.Text

  keywords VisualDescriptionKeyword[]
  tagMap   DescriptionTagMap[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sceneIntentId])
  @@index([sceneIntentId, createdAt])
  @@map("vision_iq_visual_descriptions")
}

model VisualDescriptionKeyword {
  id                  String            @id @default(uuid())
  visualDescriptionId String
  visualDescription   VisualDescription @relation(fields: [visualDescriptionId], references: [id], onDelete: Cascade)

  keyword String
  isUsed  Boolean @default(false)

  syncHistory PexelsSyncHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visualDescriptionId])
  @@map("vision_iq_visual_description_keywords")
}

model PexelsSyncHistory {
  id        String                   @id @default(uuid())
  keywordId String
  keyword   VisualDescriptionKeyword @relation(fields: [keywordId], references: [id], onDelete: Cascade)

  syncStatus   PipelineStatus @default(PENDING)
  syncAttempt  Int            @default(1)
  apiResponse  Json? // JSONB API response
  errorMessage String?
  syncedAt     DateTime?  @default(now())

  images PexelsImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([keywordId])
  @@map("vision_iq_pexels_sync_history")
}

model PexelsImage {
  id            String            @id @default(uuid())
  syncHistoryId String
  syncHistory   PexelsSyncHistory @relation(fields: [syncHistoryId], references: [id], onDelete: Cascade)

  pexelsImageId String  @unique
  url           String  @db.Text
  photographer  String?
  width         Int?
  height        Int?
  avgColor      String?
  alt           String? @db.Text

  analysisJobs ImageAnalysisJob[]
  embedding    ImageEmbedding?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([syncHistoryId])
  @@index([pexelsImageId])
  @@map("vision_iq_pexels_images")
}

model ImageAnalysisJob {
  id            String      @id @default(uuid())
  pexelsImageId String      @unique
  pexelsImage   PexelsImage @relation(fields: [pexelsImageId], references: [id], onDelete: Cascade)

  jobStatus      PipelineStatus @default(PENDING)
  provider       ApiProvider @default(DEEPSEEK)
  payload        Json? // JSONB request/config payload
  rawApiResponse Json? // JSONB raw output from the provider
  errorMessage   String?        @db.Text
  retryCount     Int            @default(0)

  startedAt   DateTime?
  completedAt DateTime?

  deepseekAnalysis DeepSeekAnalysis?
  apiLogs          ApiLog[]
  events           AnalysisEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pexelsImageId])
  @@index([jobStatus, provider])
  @@map("vision_iq_image_analysis_jobs")
}

model DeepSeekAnalysis {
  id            String           @id @default(uuid())
  analysisJobId String           @unique
  analysisJob   ImageAnalysisJob @relation(fields: [analysisJobId], references: [id], onDelete: Cascade)

  modelVersion    String @default("deepseek-v3")
  tokensUsed      Int    @default(0)
  analysisResult  Json // JSONB data: { impactScore, composition, moodDna, etc. }
  confidenceScore Float  @default(1.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([analysisJobId])
  @@map("vision_iq_deepseek_analysis")
}

// ðŸ”¹ Supporting & Performance Tables
model ApiLog {
  id    String            @id @default(uuid())
  jobId String?
  job   ImageAnalysisJob? @relation(fields: [jobId], references: [id], onDelete: SetNull)

  provider        ApiProvider
  endpoint        String
  requestPayload  Json?
  responsePayload Json?
  statusCode      Int?
  durationMs      Int?

  createdAt DateTime @default(now())

  @@index([jobId])
  @@map("vision_iq_api_logs")
}

model AnalysisEvent {
  id    String           @id @default(uuid())
  jobId String
  job   ImageAnalysisJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  eventName String
  eventData Json?

  createdAt DateTime @default(now())

  @@index([jobId])
  @@map("vision_iq_analysis_events")
}

model Tag {
  id           String              @id @default(uuid())
  name         String              @unique
  descriptions DescriptionTagMap[]

  @@map("vision_iq_tags")
}

model DescriptionTagMap {
  descriptionId String
  description   VisualDescription @relation(fields: [descriptionId], references: [id], onDelete: Cascade)
  tagId         String
  tag           Tag               @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([descriptionId, tagId])
  @@map("vision_iq_description_tag_map")
}

// ðŸ”¹ Vector Search (Specialized)
model ImageEmbedding {
  id      String      @id @default(uuid())
  imageId String      @unique
  image   PexelsImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  // 1536-dimensional embedding for semantic search
  // embedding Unsupported("vector(1536)")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([imageId])
  @@map("vision_iq_image_embeddings")
}
