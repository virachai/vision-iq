# Vision-IQ NestJS API ‚Äî Context Document (‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)

> **‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á `apps/nestjs-api`** ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á monorepo, ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô, ‡∏Å‡∏≤‡∏£‡πÑ‡∏´‡∏•‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏£‡∏∞‡∏ö‡∏ö Queue, Cron Jobs, ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ External APIs, Environment Config ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏≤‡∏ö

---

## ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç

1. [Monorepo Overview](#1-monorepo-overview)
2. [NestJS API ‚Äî Module Architecture](#2-nestjs-api--module-architecture)
3. [Data Pipeline Flow (End-to-End)](#3-data-pipeline-flow-end-to-end)
4. [Module-by-Module Context](#4-module-by-module-context)
5. [Database Schema & ER Diagram](#5-database-schema--er-diagram)
6. [Queue System (BullMQ)](#6-queue-system-bullmq)
7. [Cron Jobs & Scheduled Tasks](#7-cron-jobs--scheduled-tasks)
8. [External API Integrations](#8-external-api-integrations)
9. [Shared Types & Normalization (pipeline-types.ts)](#9-shared-types--normalization-pipeline-typests)
10. [Environment Variables](#10-environment-variables)
11. [Test Coverage Status](#11-test-coverage-status)
12. [Known Limitations & Technical Debt](#12-known-limitations--technical-debt)
13. [File Map](#13-file-map)

---

## 1. Monorepo Overview

Vision-IQ ‡πÉ‡∏ä‡πâ **Turborepo + pnpm workspaces** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ monorepo

```
vision-iq/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îî‚îÄ‚îÄ nestjs-api/          ‚Üê NestJS backend (‡∏ö‡∏ó‡∏ô‡∏µ‡πâ)
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ database/            ‚Üê Prisma schema, migrations, generated client
‚îÇ   ‚îú‚îÄ‚îÄ env/                 ‚Üê Shared environment variable definitions
‚îÇ   ‚îú‚îÄ‚îÄ api/                 ‚Üê Shared DTOs/types
‚îÇ   ‚îú‚îÄ‚îÄ logger/              ‚Üê Shared logging utilities
‚îÇ   ‚îî‚îÄ‚îÄ shared/              ‚Üê Cross-cutting utilities
‚îú‚îÄ‚îÄ docs/                    ‚Üê Documentation
‚îú‚îÄ‚îÄ scripts/                 ‚Üê Utility scripts
‚îú‚îÄ‚îÄ turbo.json               ‚Üê Turborepo pipeline config
‚îú‚îÄ‚îÄ pnpm-workspace.yaml      ‚Üê Workspace definition
‚îî‚îÄ‚îÄ package.json             ‚Üê Root package.json
```

### Package Dependencies

| Package          | Import Path         | Purpose                           |
| ---------------- | ------------------- | --------------------------------- |
| `@repo/database` | `packages/database` | Prisma Client, Schema, Migrations |
| `@repo/env`      | `packages/env`      | Environment variables (type-safe) |
| `@repo/api`      | `packages/api`      | Shared DTOs / API types           |

---

## 2. NestJS API ‚Äî Module Architecture

### Module Dependency Graph

```mermaid
graph TD
    AppModule["AppModule<br/>(Root)"]
    AppModule --> PrismaModule["PrismaModule<br/>üåê @Global"]
    AppModule --> LinksModule["LinksModule<br/>(Demo/Scaffold)"]
    AppModule --> AlignmentModule["AlignmentModule<br/>(Core Orchestrator)"]
    AppModule --> ScheduleModule["ScheduleModule.forRoot()"]

    AlignmentModule --> DeepSeekModule
    AlignmentModule --> SemanticMatchingModule
    AlignmentModule --> PexelsIntegrationModule
    AlignmentModule -->|forwardRef| QueueModule
    AlignmentModule --> ImageAnalysisModule

    QueueModule --> ImageAnalysisModule
    QueueModule -->|forwardRef| PexelsIntegrationModule
    QueueModule -->|forwardRef| AlignmentModule

    ImageAnalysisModule --> DeepSeekModule
    PexelsIntegrationModule -->|forwardRef| QueueModule

    style PrismaModule fill:#2d6a4f,color:#fff
    style AlignmentModule fill:#1d3557,color:#fff
    style QueueModule fill:#e63946,color:#fff
```

### Application Entrypoint

**`main.ts`** ‚Äî ‡πÇ‡∏´‡∏•‡∏î `@repo/env` ‡∏Å‡πà‡∏≠‡∏ô ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á NestJS app ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î CORS ‚Üí listen ‡∏ö‡∏ô port ‡∏à‡∏≤‡∏Å `env.NESTJS_API_PORT`

```typescript
// ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ boot
1. await import("@repo/env")     // ‡πÇ‡∏´‡∏•‡∏î env ‡∏Å‡πà‡∏≠‡∏ô
2. NestFactory.create(AppModule) // ‡∏™‡∏£‡πâ‡∏≤‡∏á app
3. app.enableCors()              // ‡πÄ‡∏õ‡∏¥‡∏î CORS (all origins)
4. app.listen(env.NESTJS_API_PORT)
```

---

## 3. Data Pipeline Flow (End-to-End)

Vision-IQ ‡πÅ‡∏õ‡∏•‡∏á **‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (narrative text)** ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô **‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á** ‡∏ú‡πà‡∏≤‡∏ô 5 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:

```mermaid
flowchart LR
    A["üìù Raw Text<br/>(Gemini Live)"] --> B["üß† Intent Extraction<br/>(DeepSeek)"]
    B --> C["üìã Description Expansion<br/>(DeepSeek)"]
    C --> D["üîë Keyword Extraction<br/>(DeepSeek)"]
    D --> E["üì∏ Image Sync<br/>(Pexels API)"]
    E --> F["üî¨ Image Analysis<br/>(Gemini Vision)"]
    F --> G["üéØ Semantic Matching<br/>(pgvector)"]
```

### Step-by-Step Pipeline

#### Step 1: Visual Intent Extraction

- **Input**: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å Gemini Live (‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏∏‡πà‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏•‡∏µ ‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏¢‡∏≤‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å")
- **Service**: `AlignmentService.extractVisualIntent()` ‚Üí `DeepSeekService.extractVisualIntent()`
- **Output**: Array ‡∏Ç‡∏≠‡∏á `SceneIntentDto` ‡∏ó‡∏µ‡πà‡∏°‡∏µ intent, required_impact, preferred_composition
- **DB Write**: ‡∏™‡∏£‡πâ‡∏≤‡∏á `VisualIntentRequest` + `SceneIntent` records
- **Status Tracking**: `PipelineStatus.PENDING` ‚Üí `IN_PROGRESS` ‚Üí `COMPLETED`

#### Step 2: Description Expansion (One-to-Many)

- **Input**: SceneIntent ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Step 1
- **Service**: `DeepSeekService.expandSceneIntent()`
- **Output**: ‡∏´‡∏•‡∏≤‡∏¢ VisualDescription ‡∏ï‡πà‡∏≠ 1 SceneIntent
- **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á**: intent "‡∏Ñ‡∏ô‡πÄ‡∏´‡∏á‡∏≤" ‚Üí ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô "silhouette noir ‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á", "‡∏Ñ‡∏ô‡∏ô‡∏±‡πà‡∏á‡∏£‡∏¥‡∏°‡∏ú‡∏≤ golden hour", "‡∏†‡∏≤‡∏û close-up ‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ß‡∏Å‡∏≤‡πÅ‡∏ü‡∏ß‡πà‡∏≤‡∏á"
- **DB Write**: ‡∏™‡∏£‡πâ‡∏≤‡∏á `VisualDescription` records

#### Step 3: Keyword Extraction & Auto-Sync

- **Input**: VisualDescription
- **Service**: `DeepSeekService.extractSearchKeywords()` ‚Üí `PexelsSyncService.syncPexelsLibrary()`
- **Output**: Keywords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Pexels
- **DB Write**: ‡∏™‡∏£‡πâ‡∏≤‡∏á `VisualDescriptionKeyword` records
- **Trigger**: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î `auto_match=true` ‡∏à‡∏∞ sync ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Pexels ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

#### Step 4: Image Analysis (Background/Async)

- **Input**: PexelsImage ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
- **Service**: `QueueService` ‚Üí BullMQ Worker ‚Üí `GeminiAnalysisService.analyzeImage()`
- **Process**:
  1. Fetch ‡∏†‡∏≤‡∏û ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64
  2. ‡∏™‡πà‡∏á‡πÑ‡∏õ Gemini Vision (Live Session) ‡∏û‡∏£‡πâ‡∏≠‡∏° prompt ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
  3. Parse response ‡πÄ‡∏õ‡πá‡∏ô `GeminiAnalysisResult` (impact_score, composition, mood_dna, etc.)
  4. (Optional) Refine ‡∏î‡πâ‡∏ß‡∏¢ DeepSeek 7-layer analysis ‚Üí `VisualIntentAnalysis`
- **DB Write**: `ImageAnalysisJob`, `DeepSeekAnalysis`, `VisualIntentAnalysis`

#### Step 5: Semantic Matching

- **Input**: `SceneIntentDto[]` + embedding ‡∏Ç‡∏≠‡∏á scene
- **Service**: `SemanticMatchingService.findAlignedImages()`
- **Process**:
  1. Generate embedding ‡∏Ç‡∏≠‡∏á scene (placeholder: random vector)
  2. pgvector cosine similarity search
  3. Multi-factor ranking: `0.5√óvector_sim + 0.3√óimpact + 0.15√ócomposition + 0.05√ómood`
  4. Visual Anchor Logic: ‡∏†‡∏≤‡∏û‡πÅ‡∏£‡∏Å lock mood_dna ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö scene ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
- **Output**: `ImageMatch[][]` ‚Äî ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° match_score ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ scene

---

## 4. Module-by-Module Context

### 4.1 PrismaModule (`src/prisma/`)

| Item          | Detail                                                                                   |
| ------------- | ---------------------------------------------------------------------------------------- |
| **Pattern**   | `@Global()` module ‚Äî inject ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å module                                                |
| **Providers** | `PG_POOL` (raw pg Pool), `PrismaClient` (via PrismaPg adapter), `PRISMA_SERVICE` (alias) |
| **Adapter**   | `@prisma/adapter-pg` ‚Äî Prisma ‡πÉ‡∏ä‡πâ pg Pool ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö raw SQL                               |
| **SSL**       | `rejectUnauthorized: false` (Supabase dev)                                               |

**Injection Tokens:**

```typescript
export const PG_POOL = "PG_POOL"; // raw pg Pool (SemanticMatchingService ‡πÉ‡∏ä‡πâ)
export const PRISMA_SERVICE = "PRISMA_SERVICE"; // alias ‡∏Ç‡∏≠‡∏á PrismaClient
```

**‚ö†Ô∏è Issue:** ‡∏°‡∏µ 3 ways ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ inject Prisma (PrismaClient class, PRISMA_SERVICE token, PG_POOL) ‚Üí inconsistent

---

### 4.2 AlignmentModule (`src/alignment/`)

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:** ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≤‡∏á orchestrate ‡∏ó‡∏±‡πâ‡∏á pipeline ‚Äî ‡∏£‡∏±‡∏ö request ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å DeepSeek ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á records ‚Üí trigger sync

#### Files

| File                      | Lines | Responsibility                   |
| ------------------------- | ----- | -------------------------------- |
| `alignment.module.ts`     | 24    | Module imports/exports           |
| `alignment.controller.ts` | 107   | 8 REST endpoints                 |
| `alignment.service.ts`    | 597   | Core orchestration logic         |
| `cleanup.service.ts`      | 98    | Rollback & cleanup               |
| `dto/scene-intent.dto.ts` | 63    | SceneIntentDto, ImageMatch, etc. |

#### API Endpoints

| Method | Path                                    | Purpose                            | Service Method                     |
| ------ | --------------------------------------- | ---------------------------------- | ---------------------------------- |
| POST   | `/alignment/extract-visual-intent`      | ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí scene intents        | `extractVisualIntent()`            |
| POST   | `/alignment/test-analysis`              | ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Gemini analysis ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á       | `testImageAnalysis()`              |
| POST   | `/alignment/refine-analysis/:jobId`     | Refine analysis ‡∏î‡πâ‡∏ß‡∏¢ DeepSeek      | `refineAnalysis()`                 |
| POST   | `/alignment/find-images`                | ‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö scene intents       | `findAlignedImages()`              |
| POST   | `/alignment/sync-pexels`                | sync ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Pexels                 | `syncPexelsLibrary()`              |
| POST   | `/alignment/sync-pexels/:descriptionId` | sync keyword ‡∏Ç‡∏≠‡∏á description ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ | `syncPexelsByDescription()`        |
| POST   | `/alignment/trigger-keyword-sync`       | trigger sync keywords ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ | `autoSyncUnusedKeywords()`         |
| GET    | `/alignment/stats`                      | ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏∞‡∏ö‡∏ö                          | `getStats()`                       |
| POST   | `/alignment/rollback/:requestId`        | rollback request + downstream      | `CleanupService.rollbackRequest()` |

#### Key Service Methods

**`extractVisualIntent(dto)`** ‚Äî 130+ lines of orchestration:

```
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á VisualIntentRequest (PENDING)
2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å DeepSeek extractVisualIntent ‚Üí SceneIntentDto[]
3. Loop each scene:
   a. ‡∏™‡∏£‡πâ‡∏≤‡∏á SceneIntent record
   b. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å DeepSeek expandSceneIntent ‚Üí VisualDescription[]
   c. Loop each description:
      - ‡∏™‡∏£‡πâ‡∏≤‡∏á VisualDescription record
      - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å DeepSeek extractSearchKeywords ‚Üí keywords
      - ‡∏™‡∏£‡πâ‡∏≤‡∏á VisualDescriptionKeyword records
      - ‡∏ñ‡πâ‡∏≤ auto_match ‚Üí trigger syncPexelsLibrary (fire-and-forget)
4. Update request status ‚Üí COMPLETED
5. Return SceneIntentDto[]
```

**`autoSyncUnusedKeywords()`** ‚Äî ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ keywords ‡∏ó‡∏µ‡πà `isUsed=false` ‚Üí trigger sync

**Cron Job:** `@Cron(CronExpression.EVERY_10_SECONDS)` ‚Äî process pending DeepSeek analysis

---

### 4.3 DeepSeekModule (`src/deepseek-integration/`)

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:** ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å DeepSeek API (HTTP REST) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°

#### DeepSeekService (502 lines)

| Method                                     | Input  | Output              | Purpose                            |
| ------------------------------------------ | ------ | ------------------- | ---------------------------------- |
| `extractVisualIntent(rawText)`             | string | `SceneIntentDto[]`  | ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí scene intents        |
| `expandSceneIntent(intent)`                | string | `SceneIntentDto[]`  | ‡∏Ç‡∏¢‡∏≤‡∏¢ 1 intent ‚Üí ‡∏´‡∏•‡∏≤‡∏¢ descriptions  |
| `parseGeminiRawResponse(rawResponse)`      | string | structured metadata | parse raw Gemini ‚Üí structured data |
| `analyzeDetailedVisualIntent(description)` | string | 7-layer analysis    | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å 7 ‡∏ä‡∏±‡πâ‡∏ô            |
| `extractSearchKeywords(description)`       | string | `string[]`          | ‡∏™‡∏Å‡∏±‡∏î keywords ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û       |

**Configuration:**

```
DEEPSEEK_API_KEY    ‚Üí API key
DEEPSEEK_API_URL    ‚Üí https://api.deepseek.com/chat/completions
ENABLE_DEEPSEEK     ‚Üí feature flag (true/false)
```

**Error Handling:** Exponential backoff ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö rate limit (429), retry ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á

**JSON Parsing:** ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á ```json markdown blocks ‡πÅ‡∏•‡∏∞ raw JSON objects ‚Äî ‡∏°‡∏µ fallback ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô

---

### 4.4 ImageAnalysisModule (`src/image-analysis/`)

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:** ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ Google Gemini Vision API ‡∏ú‡πà‡∏≤‡∏ô Live Session (WebSocket)

#### GeminiAnalysisService (991 lines)

| Method                                       | Purpose                                     |
| -------------------------------------------- | ------------------------------------------- |
| `analyzeImage(imageUrl)`                     | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û 1 ‡∏†‡∏≤‡∏û ‚Üí `GeminiAnalysisResult` |
| `analyzeImages(items[])`                     | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏û (batch)                 |
| `refineWithDeepSeek(jobId)`                  | ‡∏™‡πà‡∏á raw response ‡πÑ‡∏õ parse ‡∏î‡πâ‡∏ß‡∏¢ DeepSeek     |
| `analyzeVisualIntent(imageUrl, description)` | 7-layer cinematic analysis                  |

**Gemini Live Session Pattern:**

```typescript
// 1. Connect via WebSocket
const session = await ai.live.connect({
  model: "gemini-2.0-flash-001",
  config: { responseModalities: [Modality.TEXT] },
  callbacks: { onopen, onmessage, onclose, onerror },
});

// 2. Send image data (base64) + prompt
session.sendRealtimeInput({ media: { data: imageBase64, mimeType } });

// 3. Wait for turnComplete
// 4. Collect streamed text
// 5. Close session
```

**Retry Logic:** `runLiveSessionWithRetry()` ‚Äî retry ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, delay escalation 2s‚Üí4s‚Üí6s‚Üí8s‚Üí10s

**Response Parsing:**

```
1. Primary: parseRawTextResponse() ‚Äî format "IMPACT: 8\nCOMPOSITION:\n..."
2. Fallback: extractJson() ‚Üí JSON.parse() ‚Üí normalizeGeminiResult()
3. Last resort: normalizeGeminiResult({}) ‚Üí safe defaults
```

**Configuration:**

```
GEMINI_API_KEY   ‚Üí Google AI API key
ENABLE_GEMINI    ‚Üí feature flag (true/false)
```

---

### 4.5 PexelsIntegrationModule (`src/pexels-sync/`)

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:** ‡∏î‡∏∂‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Pexels API + ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö + queue analysis jobs

#### PexelsIntegrationService (243 lines)

| Method                       | Purpose                                         |
| ---------------------------- | ----------------------------------------------- |
| `syncPexelsLibrary*(query)`  | AsyncGenerator ‚Äî yield batches ‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Pexels |
| `getPexelsPage(query, page)` | fetch 1 page ‡∏à‡∏≤‡∏Å Pexels API (rate limited)      |

**Rate Limiting:** 200 requests/hr ‚Üí min interval 18s ‡∏ï‡πà‡∏≠ request  
**Retry:** Exponential backoff ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 429, max 3 retries

#### PexelsSyncService (256 lines)

| Method                                                          | Purpose                          |
| --------------------------------------------------------------- | -------------------------------- |
| `syncPexelsLibrary(query, batchSize, descriptionId, keywordId)` | orchestrate sync + ingestion     |
| `ingestionBatch(images, needsAnalysis)`                         | upsert ‡∏†‡∏≤‡∏û + ‡∏™‡∏£‡πâ‡∏≤‡∏á analysis jobs |

**Process:**

```
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á PexelsSyncHistory (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ keywordId)
2. Iterate batches ‡∏à‡∏≤‡∏Å PexelsIntegrationService
3. ‡∏ó‡∏∏‡∏Å batch ‚Üí ingestionBatch():
   a. upsert PexelsImage (by pexelsImageId)
   b. ‡∏ñ‡πâ‡∏≤ needsAnalysis ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á ImageAnalysisJob ‚Üí queue ‡πÉ‡∏ô BullMQ
4. Update SyncHistory status
5. Mark keyword isUsed=true
```

**Configuration:**

```
PEXELS_API_KEY            ‚Üí Pexels API key
ENABLE_PEXELS             ‚Üí feature flag
PEXELS_REQUESTS_PER_HOUR  ‚Üí rate limit (default: 200)
PEXELS_RETRY_DELAY_MS     ‚Üí base retry delay (default: 1000)
```

---

### 4.6 QueueModule (`src/queue/`)

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:** ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ background job processing ‡∏î‡πâ‡∏ß‡∏¢ BullMQ + Redis

#### QueueService (485 lines)

**Queues ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô 3 ‡∏ï‡∏±‡∏ß:**

| Queue Name             | Purpose                       | Concurrency |
| ---------------------- | ----------------------------- | ----------- |
| `image-analysis`       | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ Gemini       | 3           |
| `embedding-generation` | ‡∏™‡∏£‡πâ‡∏≤‡∏á vector embeddings       | 5           |
| `auto-sync`            | trigger Pexels sync ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | 2           |

**Job Processing Flow:**

```mermaid
flowchart TD
    Q1[image-analysis Queue]
    Q2[embedding-generation Queue]
    Q3[auto-sync Queue]

    Q1 --> W1[Worker: processImageAnalysis]
    Q2 --> W2[Worker: processEmbeddingGeneration]
    Q3 --> W3[Worker: processAutoSync]

    W1 --> |success| DB1[Update ImageAnalysisJob<br/>+ DeepSeekAnalysis]
    W1 --> |failure| E1[Retry up to 3x]
    W2 --> |‚ö†Ô∏è disabled| DB2[Placeholder: Math.sin]
    W3 --> |success| DB3[Trigger PexelsSyncService]
```

**‚ö†Ô∏è Embedding generation ‡∏ñ‡∏π‡∏Å disable:** method `processEmbeddingGeneration` ‡πÉ‡∏ä‡πâ `Math.sin()` placeholder

#### AnalysisSchedulerService (166 lines)

**Cron Jobs 3 ‡∏ï‡∏±‡∏ß:**

| Cron                         | Interval     | Method                     | Purpose                                       |
| ---------------------------- | ------------ | -------------------------- | --------------------------------------------- |
| `handleUnusedKeywords`       | Every 5 min  | `autoSyncUnusedKeywords()` | sync keywords ‡∏ó‡∏µ‡πà `isUsed=false`              |
| `handlePendingJobs`          | Every 5 min  | re-queue pending jobs      | jobs ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á PENDING                          |
| `handleStalledOrchestration` | Every 10 min | `resumeProcessing()`       | resume requests/scenes/descriptions ‡∏ó‡∏µ‡πà stall |

---

### 4.7 SemanticMatchingModule (`src/semantic-matching/`)

**‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å:** ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö scene intent ‡∏î‡πâ‡∏ß‡∏¢ vector similarity + metadata ranking

#### SemanticMatchingService (401 lines)

**Injection:** `@Inject(PG_POOL)` ‚Äî ‡πÉ‡∏ä‡πâ raw SQL ‡∏Å‡∏±‡∏ö pgvector ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô Prisma)

**Ranking Formula:**

```
final_score = (0.50 √ó vector_similarity)
            + (0.30 √ó impact_relevance)
            + (0.15 √ó composition_match)
            + (0.05 √ó mood_consistency √ó mood_multiplier)

weighted_final_score = final_score √ó (0.8 + intentDepthScore √ó 0.2)
```

**Visual Anchor Logic:**

```
Scene 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‚Üí lock mood_dna ‡πÄ‡∏õ‡πá‡∏ô "visual anchor"
Scene 2+: ‡πÉ‡∏ä‡πâ mood_dna ‡∏Ç‡∏≠‡∏á anchor ‡πÄ‡∏õ‡πá‡∏ô constraint ‚Üí
          ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ mood ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á anchor ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô mood_consistency ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤
```

**Composition Match Scoring:**

| Match                       | Score |
| --------------------------- | ----- |
| Exact shot_type match       | +0.5  |
| Adjacent shot_type (1 step) | +0.25 |
| Exact angle match           | +0.5  |
| Any other angle             | +0.1  |

**‚ö†Ô∏è Known Issue:** `generateEmbeddingForScene()` return random 1536-dim vector (placeholder)

---

### 4.8 LinksModule (`src/links/`)

**Status:** Scaffold/Demo ‚Äî ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á

- CRUD controller + service
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô hardcoded in-memory array
- ‡∏°‡∏µ TODO comments ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö implement ‡∏à‡∏£‡∏¥‡∏á

---

## 5. Database Schema & ER Diagram

### ER Diagram

```mermaid
erDiagram
    User {
        uuid id PK
        string name
        string email UK
        datetime emailVerified
    }

    VisualIntentRequest {
        uuid id PK
        uuid userId FK
        text rawGeminiText
        enum status
        int retryCount
        text errorMessage
        datetime deletedAt
        datetime createdAt
        datetime updatedAt
    }

    SceneIntent {
        uuid id PK
        uuid visualIntentRequestId FK
        int sceneIndex
        text intent
        float requiredImpact
        json composition
        enum status
        int retryCount
    }

    VisualDescription {
        uuid id PK
        uuid sceneIntentId FK
        text description
        enum status
        int retryCount
    }

    VisualDescriptionKeyword {
        uuid id PK
        uuid visualDescriptionId FK
        string keyword
        boolean isUsed
    }

    PexelsSyncHistory {
        uuid id PK
        uuid keywordId FK
        enum syncStatus
        int syncAttempt
        json apiResponse
    }

    PexelsImage {
        uuid id PK
        uuid syncHistoryId FK
        string pexelsImageId UK
        text url
        string photographer
        int width
        int height
    }

    ImageAnalysisJob {
        uuid id PK
        uuid pexelsImageId FK "UK"
        enum jobStatus
        enum provider
        json payload
        json rawApiResponse
        int retryCount
    }

    DeepSeekAnalysis {
        uuid id PK
        uuid analysisJobId FK "UK"
        string modelVersion
        int tokensUsed
        json analysisResult
        float confidenceScore
    }

    ImageEmbedding {
        uuid id PK
        uuid imageId FK "UK"
        vector_1536 embedding
    }

    VisualIntentAnalysis {
        uuid id PK
        uuid pexelsImageId FK "UK"
        json coreIntent
        json spatialStrategy
        json subjectTreatment
        json colorPsychology
        json emotionalArchitecture
        json metaphoricalLayer
        json cinematicLeverage
    }

    ApiLog {
        uuid id PK
        uuid jobId FK
        enum provider
        string endpoint
        int statusCode
        int durationMs
    }

    AnalysisEvent {
        uuid id PK
        uuid jobId FK
        string eventName
        json eventData
    }

    Tag {
        uuid id PK
        string name UK
    }

    DescriptionTagMap {
        uuid descriptionId PK "FK"
        uuid tagId PK "FK"
    }

    User ||--o{ VisualIntentRequest : "has many"
    VisualIntentRequest ||--|{ SceneIntent : "has many (cascade)"
    SceneIntent ||--|{ VisualDescription : "has many (cascade)"
    VisualDescription ||--|{ VisualDescriptionKeyword : "has many (cascade)"
    VisualDescription ||--o{ DescriptionTagMap : "has many (cascade)"
    VisualDescriptionKeyword ||--o{ PexelsSyncHistory : "has many (cascade)"
    PexelsSyncHistory ||--|{ PexelsImage : "has many (cascade)"
    PexelsImage ||--o| ImageAnalysisJob : "has one (cascade)"
    PexelsImage ||--o| ImageEmbedding : "has one (cascade)"
    PexelsImage ||--o| VisualIntentAnalysis : "has one (cascade)"
    ImageAnalysisJob ||--o| DeepSeekAnalysis : "has one (cascade)"
    ImageAnalysisJob ||--o{ ApiLog : "has many (set null)"
    ImageAnalysisJob ||--o{ AnalysisEvent : "has many (cascade)"
    Tag ||--o{ DescriptionTagMap : "has many (cascade)"
```

### Data Lineage (Cascade Chain)

```
User
 ‚îî‚îÄ‚îÄ VisualIntentRequest (onDelete: SetNull)
      ‚îî‚îÄ‚îÄ SceneIntent (onDelete: Cascade)
           ‚îî‚îÄ‚îÄ VisualDescription (onDelete: Cascade)
                ‚îú‚îÄ‚îÄ VisualDescriptionKeyword (onDelete: Cascade)
                ‚îÇ    ‚îî‚îÄ‚îÄ PexelsSyncHistory (onDelete: Cascade)
                ‚îÇ         ‚îî‚îÄ‚îÄ PexelsImage (onDelete: Cascade) ‚ö†Ô∏è
                ‚îÇ              ‚îú‚îÄ‚îÄ ImageAnalysisJob (onDelete: Cascade)
                ‚îÇ              ‚îÇ    ‚îú‚îÄ‚îÄ DeepSeekAnalysis (onDelete: Cascade)
                ‚îÇ              ‚îÇ    ‚îú‚îÄ‚îÄ ApiLog (onDelete: SetNull)
                ‚îÇ              ‚îÇ    ‚îî‚îÄ‚îÄ AnalysisEvent (onDelete: Cascade)
                ‚îÇ              ‚îú‚îÄ‚îÄ ImageEmbedding (onDelete: Cascade)
                ‚îÇ              ‚îî‚îÄ‚îÄ VisualIntentAnalysis (onDelete: Cascade)
                ‚îî‚îÄ‚îÄ DescriptionTagMap (onDelete: Cascade)
```

> **‚ö†Ô∏è Cascade Risk:** ‡∏Å‡∏≤‡∏£‡∏•‡∏ö `PexelsSyncHistory` ‡∏à‡∏∞ cascade ‡∏•‡∏ö PexelsImage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á + analysis + embeddings

### Enums

| Enum             | Values                                                              |
| ---------------- | ------------------------------------------------------------------- |
| `PipelineStatus` | `PENDING`, `QUEUED`, `PROCESSING`, `COMPLETED`, `FAILED`, `STALLED` |
| `ApiProvider`    | `PEXELS`, `DEEPSEEK`, `OPENAI`, `GEMINI`                            |

### Table Naming Convention

‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πâ prefix `vision_iq_` ‡∏ú‡πà‡∏≤‡∏ô `@@map()`:

```
vision_iq_users
vision_iq_visual_intent_requests
vision_iq_scene_intents
vision_iq_visual_descriptions
vision_iq_visual_description_keywords
vision_iq_pexels_sync_history
vision_iq_pexels_images
vision_iq_image_analysis_jobs
vision_iq_deepseek_analysis
vision_iq_api_logs
vision_iq_analysis_events
vision_iq_tags
vision_iq_description_tag_map
vision_iq_visual_intent_analysis
vision_iq_image_embeddings
```

---

## 6. Queue System (BullMQ)

### Architecture

```mermaid
flowchart LR
    subgraph "NestJS Process"
        QS[QueueService]
        AS[AnalysisSchedulerService]
    end

    subgraph "Redis"
        Q1["Queue: image-analysis"]
        Q2["Queue: embedding-generation"]
        Q3["Queue: auto-sync"]
    end

    subgraph "Workers (in-process)"
        W1["Worker 1<br/>concurrency: 3"]
        W2["Worker 2<br/>concurrency: 5"]
        W3["Worker 3<br/>concurrency: 2"]
    end

    QS --> Q1
    QS --> Q2
    QS --> Q3
    AS -->|cron| QS

    Q1 --> W1
    Q2 --> W2
    Q3 --> W3

    W1 -->|GeminiAnalysisService| GA[Gemini Vision API]
    W3 -->|PexelsSyncService| PA[Pexels API]
```

### Job Options

| Queue                  | Attempts | Backoff         | Remove on Complete |
| ---------------------- | -------- | --------------- | ------------------ |
| `image-analysis`       | 3        | exponential, 2s | last 100           |
| `embedding-generation` | 3        | exponential, 2s | last 100           |
| `auto-sync`            | 2        | exponential, 5s | last 50            |

### Event Listeners

‡∏ó‡∏∏‡∏Å Queue ‡∏°‡∏µ event listeners:

```
completed ‚Üí log success + jobId + return value
failed ‚Üí log error + jobId + failedReason
stalled ‚Üí log warning
error ‚Üí log error
```

---

## 7. Cron Jobs & Scheduled Tasks

| Job                              | Location                   | Schedule     | Purpose                                              |
| -------------------------------- | -------------------------- | ------------ | ---------------------------------------------------- |
| `handleUnusedKeywords`           | `AnalysisSchedulerService` | Every 5 min  | Sync keywords ‡∏ó‡∏µ‡πà `isUsed=false` ‚Üí queue auto-sync   |
| `handlePendingJobs`              | `AnalysisSchedulerService` | Every 5 min  | Re-queue `PENDING` analysis jobs ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á             |
| `handleStalledOrchestration`     | `AnalysisSchedulerService` | Every 10 min | Resume requests/scenes/descriptions ‡∏ó‡∏µ‡πà stall        |
| `processPendingDeepSeekAnalysis` | `AlignmentService`         | Every 10 sec | Process completed Gemini jobs ‚Üí refine ‡∏î‡πâ‡∏ß‡∏¢ DeepSeek |

---

## 8. External API Integrations

### DeepSeek API

| Item             | Detail                                                                    |
| ---------------- | ------------------------------------------------------------------------- |
| **Protocol**     | HTTP REST (axios)                                                         |
| **Endpoint**     | `DEEPSEEK_API_URL` (default: `https://api.deepseek.com/chat/completions`) |
| **Model**        | DeepSeek-V3 (deepseek-chat)                                               |
| **Auth**         | Bearer token (`DEEPSEEK_API_KEY`)                                         |
| **Rate Limit**   | Exponential backoff on 429                                                |
| **Feature Flag** | `ENABLE_DEEPSEEK`                                                         |

### Google Gemini API

| Item             | Detail                                       |
| ---------------- | -------------------------------------------- |
| **Protocol**     | WebSocket (Live Session) via `@google/genai` |
| **Model**        | `gemini-2.0-flash-001`                       |
| **Auth**         | API key (`GEMINI_API_KEY`)                   |
| **Mode**         | `Modality.TEXT` (response)                   |
| **Retry**        | 5 attempts, delay escalation 2s‚Üí10s          |
| **Feature Flag** | `ENABLE_GEMINI`                              |

### Pexels API

| Item             | Detail                                           |
| ---------------- | ------------------------------------------------ |
| **Protocol**     | HTTP REST (axios)                                |
| **Endpoint**     | `https://api.pexels.com/v1/search`               |
| **Auth**         | API key in `Authorization` header                |
| **Rate Limit**   | 200 req/hr (client-side enforced, ~18s interval) |
| **Retry**        | 3 attempts, exponential backoff on 429           |
| **Feature Flag** | `ENABLE_PEXELS`                                  |

### Redis

| Item         | Detail                                          |
| ------------ | ----------------------------------------------- |
| **Protocol** | Redis protocol                                  |
| **URL**      | `REDIS_URL` (default: `redis://localhost:6379`) |
| **Usage**    | BullMQ queues + workers                         |

### PostgreSQL

| Item          | Detail                             |
| ------------- | ---------------------------------- |
| **Protocol**  | PostgreSQL                         |
| **URL**       | `DATABASE_URL` (via `process.env`) |
| **ORM**       | Prisma + raw pg Pool               |
| **Extension** | pgvector (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö embedding search) |
| **SSL**       | `rejectUnauthorized: false`        |

---

## 9. Shared Types & Normalization (pipeline-types.ts)

**File:** `src/shared/pipeline-types.ts` (186 lines)

### Core Types

```typescript
// Composition ‚Äî 5 fields
interface Composition {
  negative_space: "left" | "right" | "center";
  shot_type: "CU" | "MS" | "WS";
  angle: "low" | "eye" | "high";
  balance: "symmetrical" | "asymmetrical";
  subject_dominance: "weak" | "moderate" | "strong";
}

// MoodDna ‚Äî 5 fields
interface MoodDna {
  temp: "warm" | "cold";
  primary_color: string; // hex e.g. "#E8D4C0"
  vibe: string; // e.g. "minimalist"
  emotional_intensity: string; // "low" | "medium" | "strong"
  rhythm: string; // "calm" | "dynamic" | "tense"
}

// ColorProfile ‚Äî 4 fields
interface ColorProfile {
  temperature: "warm" | "cold";
  primary_color: string;
  secondary_colors: string[];
  contrast_level: "low" | "medium" | "high";
}

// GeminiAnalysisResult ‚Äî canonical analysis output
interface GeminiAnalysisResult {
  impact_score: number; // 1-10
  visual_weight: number; // 1-10
  composition: Composition;
  color_profile: ColorProfile;
  mood_dna: MoodDna;
  metaphorical_tags: string[];
  cinematic_notes: string;
}
```

### Normalization Functions

| Function                                              | Purpose                                                                     |
| ----------------------------------------------------- | --------------------------------------------------------------------------- |
| `normalizeGeminiResult(parsed)`                       | Any ‚Üí `GeminiAnalysisResult` with safe defaults                             |
| `normalizeComposition(comp)`                          | Any ‚Üí `Composition` with defaults (center, MS, eye, asymmetrical, moderate) |
| `normalizeMoodDna(mood, fallbackTemp, fallbackColor)` | Any ‚Üí `MoodDna` with defaults                                               |

**‡∏ó‡∏±‡πâ‡∏á 3 functions ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö partial/missing/malformed data** ‚Äî ‡∏ó‡∏∏‡∏Å field ‡∏°‡∏µ default value

---

## 10. Environment Variables

| Variable                   | Required | Default                                     | Used By                               |
| -------------------------- | -------- | ------------------------------------------- | ------------------------------------- |
| `DATABASE_URL`             | ‚úÖ       | ‚Äî                                           | PrismaModule (pg Pool)                |
| `NESTJS_API_PORT`          | ‚úÖ       | ‚Äî                                           | main.ts                               |
| `REDIS_URL`                | ‚úÖ       | ‚Äî                                           | QueueService (BullMQ)                 |
| `DEEPSEEK_API_KEY`         | ‚ö†Ô∏è       | `""`                                        | DeepSeekService                       |
| `DEEPSEEK_API_URL`         | ‚ö†Ô∏è       | `https://api.deepseek.com/chat/completions` | DeepSeekService                       |
| `ENABLE_DEEPSEEK`          | No       | `false`                                     | DeepSeekService feature flag          |
| `GEMINI_API_KEY`           | ‚ö†Ô∏è       | ‚Äî                                           | GeminiAnalysisService                 |
| `ENABLE_GEMINI`            | No       | `false`                                     | GeminiAnalysisService feature flag    |
| `PEXELS_API_KEY`           | ‚ö†Ô∏è       | `""`                                        | PexelsIntegrationService              |
| `ENABLE_PEXELS`            | No       | `false`                                     | PexelsIntegrationService feature flag |
| `PEXELS_REQUESTS_PER_HOUR` | No       | `200`                                       | PexelsIntegrationService              |
| `PEXELS_RETRY_DELAY_MS`    | No       | `1000`                                      | PexelsIntegrationService              |
| `BATCH_FAILURE_THRESHOLD`  | No       | `0.1`                                       | PexelsSyncService                     |
| `AUTH_SECRET`              | No       | ‚Äî                                           | (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô nestjs-api)           |

---

## 11. Test Coverage Status

### Existing Tests

| File                           | Lines | Coverage                                                        |
| ------------------------------ | ----- | --------------------------------------------------------------- |
| `alignment.controller.spec.ts` | 94    | 4 test cases (basic delegation)                                 |
| `alignment.service.spec.ts`    | 243   | 5 test cases (extractVisualIntent, findAlignedImages, getStats) |

### Missing Tests

| Service/Module             | Status      |
| -------------------------- | ----------- |
| `QueueService`             | ‚ùå No tests |
| `GeminiAnalysisService`    | ‚ùå No tests |
| `DeepSeekService`          | ‚ùå No tests |
| `PexelsSyncService`        | ‚ùå No tests |
| `PexelsIntegrationService` | ‚ùå No tests |
| `SemanticMatchingService`  | ‚ùå No tests |
| `CleanupService`           | ‚ùå No tests |
| `AnalysisSchedulerService` | ‚ùå No tests |

### Estimated Coverage: **~15-20%**

---

## 12. Known Limitations & Technical Debt

### Critical

| #   | Issue                                                                                                                                  | Location                                  |
| --- | -------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------- |
| 1   | **No authentication/authorization** ‚Äî all endpoints are public                                                                         | All controllers                           |
| 2   | **No input validation** ‚Äî no `ValidationPipe`, DTOs lack decorators                                                                    | All endpoints                             |
| 3   | **Placeholder embeddings** ‚Äî `Math.random()` and `Math.sin()` instead of real API                                                      | `SemanticMatchingService`, `QueueService` |
| 4   | **Schema drift** ‚Äî raw SQL in `SemanticMatchingService` references columns that don't exist in schema (`da.imageId`, `da.impactScore`) | `semantic-matching.service.ts:117-137`    |
| 5   | **No Prisma transactions** ‚Äî multi-step DB writes without atomicity                                                                    | `AlignmentService.extractVisualIntent`    |

### Moderate

| #   | Issue                                                           | Location                                           |
| --- | --------------------------------------------------------------- | -------------------------------------------------- |
| 6   | 3 circular dependency chains (via `forwardRef`)                 | Module imports                                     |
| 7   | Hardcoded magic numbers (batch sizes, retry counts, thresholds) | Throughout services                                |
| 8   | Fire-and-forget async calls (no `await`)                        | `AlignmentService` line 136-149                    |
| 9   | CORS open to all origins                                        | `main.ts`                                          |
| 10  | `console.log()` instead of NestJS Logger                        | `prisma.module.ts`, `semantic-matching.service.ts` |
| 11  | No request correlation ID / structured logging                  | All services                                       |
| 12  | Embedding column commented out in Prisma but used in raw SQL    | `schema.prisma:303`                                |

### Low

| #   | Issue                                                               |
| --- | ------------------------------------------------------------------- |
| 13  | `LinksModule` is scaffold code (in-memory hardcoded data)           |
| 14  | Debug/test files committed (`debug-getStats.log`, `queue_fail.log`) |
| 15  | Mixed snake_case/camelCase in DTOs                                  |
| 16  | `@ts-ignore` in `AlignmentService`                                  |

---

## 13. File Map

```
apps/nestjs-api/src/
‚îú‚îÄ‚îÄ main.ts                                     # Application entrypoint
‚îú‚îÄ‚îÄ app.module.ts                               # Root module
‚îú‚îÄ‚îÄ app.controller.ts                           # Health check "/"
‚îú‚îÄ‚îÄ app.service.ts                              # "Hello World"
‚îÇ
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ prisma.module.ts                        # @Global PrismaClient + PG_POOL
‚îÇ
‚îú‚îÄ‚îÄ alignment/
‚îÇ   ‚îú‚îÄ‚îÄ alignment.module.ts                     # Core orchestrator module
‚îÇ   ‚îú‚îÄ‚îÄ alignment.controller.ts                 # 8 REST endpoints
‚îÇ   ‚îú‚îÄ‚îÄ alignment.service.ts                    # 597-line orchestration service
‚îÇ   ‚îú‚îÄ‚îÄ alignment.controller.spec.ts            # Controller tests
‚îÇ   ‚îú‚îÄ‚îÄ alignment.service.spec.ts               # Service tests
‚îÇ   ‚îú‚îÄ‚îÄ cleanup.service.ts                      # Rollback & cleanup
‚îÇ   ‚îî‚îÄ‚îÄ dto/
‚îÇ       ‚îî‚îÄ‚îÄ scene-intent.dto.ts                 # SceneIntentDto, ImageMatch, etc.
‚îÇ
‚îú‚îÄ‚îÄ deepseek-integration/
‚îÇ   ‚îú‚îÄ‚îÄ deepseek.module.ts                      # DeepSeek module
‚îÇ   ‚îî‚îÄ‚îÄ deepseek.service.ts                     # 502-line DeepSeek API service
‚îÇ
‚îú‚îÄ‚îÄ image-analysis/
‚îÇ   ‚îú‚îÄ‚îÄ image-analysis.module.ts                # Gemini analysis module
‚îÇ   ‚îî‚îÄ‚îÄ gemini-analysis.service.ts              # 991-line Gemini Vision service
‚îÇ
‚îú‚îÄ‚îÄ pexels-sync/
‚îÇ   ‚îú‚îÄ‚îÄ pexels-integration.module.ts            # Pexels module
‚îÇ   ‚îú‚îÄ‚îÄ pexels-integration.service.ts           # 243-line Pexels API client
‚îÇ   ‚îî‚îÄ‚îÄ pexels-sync.service.ts                  # 256-line sync orchestrator
‚îÇ
‚îú‚îÄ‚îÄ queue/
‚îÇ   ‚îú‚îÄ‚îÄ queue.module.ts                         # BullMQ module
‚îÇ   ‚îú‚îÄ‚îÄ queue.service.ts                        # 485-line queue manager
‚îÇ   ‚îî‚îÄ‚îÄ analysis-scheduler.service.ts           # 166-line cron jobs
‚îÇ
‚îú‚îÄ‚îÄ semantic-matching/
‚îÇ   ‚îú‚îÄ‚îÄ semantic-matching.module.ts             # Vector search module
‚îÇ   ‚îî‚îÄ‚îÄ semantic-matching.service.ts            # 401-line pgvector search
‚îÇ
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îî‚îÄ‚îÄ pipeline-types.ts                       # 186-line shared types & normalization
‚îÇ
‚îî‚îÄ‚îÄ links/
    ‚îú‚îÄ‚îÄ links.module.ts                         # Demo module (scaffold)
    ‚îú‚îÄ‚îÄ links.controller.ts                     # Demo CRUD controller
    ‚îî‚îÄ‚îÄ links.service.ts                        # Demo service (in-memory)
```

---

> **Document Version:** 1.0  
> **Last Updated:** 2026-02-14  
> **Scope:** `apps/nestjs-api` only (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° frontend apps)
